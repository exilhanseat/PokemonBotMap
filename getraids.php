<?php
echo '[{"id":"2218","user_id":"4711","pokemon":"286-normal","first_seen":"2019-03-07 11:06:00","start_time":"2019-03-07 12:04:00","end_time":"2019-03-07 12:49:00","timezone":"Europe\/Berlin","gym_team":"valor","gym_id":"135","gym_name":"INRI Wulf-Unterzell","lat":"48.38163800","lon":"10.99498500","ts_end":"1551959340","ts_start":"1551956640","t_left":"131","raid_level":"2","pokedex_id":"286","pokemon_name":"Breloom","interest":null,"count":"0","extra_mystic":"0","extra_valor":"0","extra_instinct":"0","total_extras":"0","move_1":"Konter","move_2":"Wuchtschlag","chat_id":"-1001283446824","message_id":"2152","team":"2","image_link":null},{"id":"2219","user_id":"4711","pokemon":"483-normal","first_seen":"2019-03-07 11:12:00","start_time":"2019-03-07 12:09:00","end_time":"2019-03-07 12:54:00","timezone":"Europe\/Berlin","gym_team":"mystic","gym_id":"115","gym_name":"Naturschutzgebiet Stadtwald Augsburg","lat":"48.34319400","lon":"10.93420600","ts_end":"1551959640","ts_start":"1551956940","t_left":"431","raid_level":"5","pokedex_id":"483","pokemon_name":"Dialga","interest":null,"count":"0","extra_mystic":"0","extra_valor":"0","extra_instinct":"0","total_extras":"0","move_1":"Metallklaue","move_2":"Eisensch\u00e4del","chat_id":"-1001283446824","message_id":"2153","team":"1","image_link":"http:\/\/lh3.googleusercontent.com\/0KFJgMRIUASFlmmTMwoweOeLFn9NfFaaW5Ld3uN2ZYDEtJx5B6kkg_vcjRfKMWSQtsUP-a2zng654AnOr_o"},{"id":"2221","user_id":"4711","pokemon":"147-normal","first_seen":"2019-03-07 11:48:00","start_time":"2019-03-07 12:12:00","end_time":"2019-03-07 12:57:00","timezone":"Europe\/Berlin","gym_team":"mystic","gym_id":"121","gym_name":"Wasserturm Derching","lat":"48.39011600","lon":"10.99173300","ts_end":"1551959820","ts_start":"1551957120","t_left":"611","raid_level":"1","pokedex_id":"147","pokemon_name":"Dratini","interest":null,"count":"0","extra_mystic":"0","extra_valor":"0","extra_instinct":"0","total_extras":"0","move_1":"Eisenschweif","move_2":"Windhose","chat_id":"-1001283446824","message_id":"2155","team":"1","image_link":null},{"id":"2220","user_id":"4711","pokemon":"248-normal","first_seen":"2019-03-07 11:34:00","start_time":"2019-03-07 12:32:00","end_time":"2019-03-07 13:17:00","timezone":"Europe\/Berlin","gym_team":"valor","gym_id":"109","gym_name":"Kirche","lat":"48.35490900","lon":"10.94615900","ts_end":"1551961020","ts_start":"1551958320","t_left":"1811","raid_level":"4","pokedex_id":"248","pokemon_name":"Tyranitar","interest":null,"count":"0","extra_mystic":"0","extra_valor":"0","extra_instinct":"0","total_extras":"0","move_1":"Biss","move_2":"Steinkante","chat_id":"-1001283446824","message_id":"2154","team":"2","image_link":"http:\/\/lh3.googleusercontent.com\/GmilROE80M0dGk6cmESrfxllN8t_aZVFeWz6UmJtwQjha7YHZoqMhrvmJLNoSOSxoYAIXJbVPntpcv-w692Y"},{"id":"2222","user_id":"4711","pokemon":"9992-normal","first_seen":"2019-03-07 12:00:00","start_time":"2019-03-07 12:35:00","end_time":"2019-03-07 13:20:00","timezone":"Europe\/Berlin","gym_team":"mystic","gym_id":"118","gym_name":"St. Franziskus Kapelle","lat":"48.40884700","lon":"10.97948900","ts_end":"1551961200","ts_start":"1551958500","t_left":"1991","raid_level":"2","pokedex_id":"9992","pokemon_name":"Level 2 Egg","interest":null,"count":"0","extra_mystic":"0","extra_valor":"0","extra_instinct":"0","total_extras":"0","move_1":null,"move_2":null,"chat_id":"-1001283446824","message_id":"2156","team":"1","image_link":null},{"id":"2223","user_id":"4711","pokemon":"9992-normal","first_seen":"2019-03-07 12:16:00","start_time":"2019-03-07 13:11:00","end_time":"2019-03-07 13:56:00","timezone":"Europe\/Berlin","gym_team":"mystic","gym_id":"148","gym_name":"Stone Face","lat":"48.34878070","lon":"10.99139520","ts_end":"1551963360","ts_start":"1551960660","t_left":"4151","raid_level":"2","pokedex_id":"9992","pokemon_name":"Level 2 Egg","interest":null,"count":"0","extra_mystic":"0","extra_valor":"0","extra_instinct":"0","total_extras":"0","move_1":null,"move_2":null,"chat_id":"-1001283446824","message_id":"2157","team":"1","image_link":"http:\/\/lh4.ggpht.com\/x8K2j9QvhEEE9b0TGcpmyCKSU0hSCy3Npe1tnU4U1P0ztQkAXeYxGP-3HO2ysbl74c0gJllrcUdQUx_5RZU"},{"id":"2224","user_id":"4711","pokemon":"9993-normal","first_seen":"2019-03-07 12:24:00","start_time":"2019-03-07 13:20:00","end_time":"2019-03-07 14:05:00","timezone":"Europe\/Berlin","gym_team":"instinct","gym_id":"152","gym_name":"Gebetsst\u00e4tte","lat":"48.34183690","lon":"10.98861160","ts_end":"1551963900","ts_start":"1551961200","t_left":"4691","raid_level":"3","pokedex_id":"9993","pokemon_name":"Level 3 Egg","interest":null,"count":"0","extra_mystic":"0","extra_valor":"0","extra_instinct":"0","total_extras":"0","move_1":null,"move_2":null,"chat_id":"-1001283446824","message_id":"2158","team":"3","image_link":"http:\/\/lh3.googleusercontent.com\/y7Vky25KoMUKXXLuTWVhxCU_VVCP76a5LTFcny8Pyu4swGsAldL32ZmSKWiMoV6SHGBHc2pvwfKFh6cKHY2UGQ"},{"id":"2225","user_id":"4711","pokemon":"9995-normal","first_seen":"2019-03-07 12:24:00","start_time":"2019-03-07 13:21:00","end_time":"2019-03-07 14:06:00","timezone":"Europe\/Berlin","gym_team":"instinct","gym_id":"147","gym_name":"Die Arche","lat":"48.35217450","lon":"10.98560350","ts_end":"1551963960","ts_start":"1551961260","t_left":"4751","raid_level":"0","pokedex_id":"9995","pokemon_name":"Level 5 Egg","interest":"222","count":"1","extra_mystic":"0","extra_valor":"1","extra_instinct":"2","total_extras":"3","move_1":null,"move_2":null,"chat_id":"-1001283446824","message_id":"2159","team":"3","image_link":"http:\/\/lh3.ggpht.com\/UFxSRoUsyF_2YuzEzftclG_vvTvL7WcWiOevtPdA6xO0T2gDwXJCxXN3cA1D-dvTzFEjmak7xJG_Dd4rr5on","raiders":{"13:25":{"raid_id":"2225","attend_time":"13:25","pokemon_name":"Pokemon egal","pokedex_id":"0","raiders":"4"}}},{"id":"2226","user_id":"4711","pokemon":"9992-normal","first_seen":"2019-03-07 12:40:00","start_time":"2019-03-07 13:38:00","end_time":"2019-03-07 14:23:00","timezone":"Europe\/Berlin","gym_team":"mystic","gym_id":"104","gym_name":"Lechfall","lat":"48.34427000","lon":"10.93620300","ts_end":"1551964980","ts_start":"1551962280","t_left":"5771","raid_level":"2","pokedex_id":"9992","pokemon_name":"Level 2 Egg","interest":null,"count":"0","extra_mystic":"0","extra_valor":"0","extra_instinct":"0","total_extras":"0","move_1":null,"move_2":null,"chat_id":"-1001283446824","message_id":"2160","team":"1","image_link":"http:\/\/lh5.ggpht.com\/I_i7kiDG_LDCNUSygdJTUC-ZHvgCHXBMxOa6KOhzpvb8Q0DDA1MXw8Ts0opgCdJAYMbT9scEqMfdkNQ9ZYuQig"}]';
/*<?php
// Use same config as bot
require_once ("config.php");

// Establish mysql connection.
$dbh = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4", DB_USER, DB_PASSWORD, array(
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
));
$dbh->setAttribute(PDO::ATTR_ORACLE_NULLS, PDO::NULL_EMPTY_STRING);

$sql_raids = "
    SELECT    raids.*,
      gyms.gym_name,
      gyms.lat,
      gyms.lon,
      UNIX_TIMESTAMP(raids.end_time) AS ts_end,
      UNIX_TIMESTAMP(raids.start_time) AS ts_start,
      UNIX_TIMESTAMP(raids.end_time)-UNIX_TIMESTAMP(NOW()) AS t_left,
      pokemon.raid_level,
      pokemon.pokedex_id,
      pokemon.pokemon_name,
      attendance.id AS interest,
      SUM(CASE WHEN attendance.cancel=FALSE AND attendance.raid_done=FALSE THEN 1 ELSE 0 END) AS count,
      SUM(CASE WHEN attendance.cancel=FALSE and attendance.raid_done=FALSE THEN attendance.extra_mystic ELSE 0 END) AS extra_mystic,
      SUM(CASE WHEN attendance.cancel=FALSE and attendance.raid_done=FALSE THEN attendance.extra_valor ELSE 0 END) AS extra_valor,
      SUM(CASE WHEN attendance.cancel=FALSE and attendance.raid_done=FALSE THEN attendance.extra_instinct ELSE 0 END) AS extra_instinct,
      SUM(CASE WHEN attendance.cancel=FALSE and attendance.raid_done=FALSE THEN (attendance.extra_mystic+attendance.extra_valor+attendance.extra_instinct) ELSE 0 END) AS total_extras,
      moves.move_1 as move_1,
      moves.move_2 as move_2,
      cleanup.chat_id as chat_id,
      cleanup.message_id as message_id
    FROM raids
      LEFT JOIN pokemon ON pokemon.pokedex_id=raids.pokemon
      LEFT JOIN attendance ON attendance.raid_id=raids.id
      LEFT JOIN gyms ON gyms.id = raids.gym_id
      LEFT JOIN moves on moves.id = raids.gym_id
      LEFT JOIN cleanup on cleanup.raid_id = raids.id
    WHERE raids.end_time > NOW()
      AND raids.end_time < NOW() + INTERVAL " . MAP_RAID_END_TIME_OFFSET_HOURS . " hour
    GROUP BY  gyms.gym_name
    ORDER BY  raids.end_time ASC";

$sql_raiders = "
    SELECT
        attendance.raid_id,
        (CASE WHEN DATE_FORMAT(attendance.attend_time, '%H:%i') = '01:00' THEN 'Jederzeit' ELSE DATE_FORMAT(attendance.attend_time, '%H:%i') END) as attend_time,
        (CASE WHEN pokemon.pokemon_name = 'Any' THEN 'Pokemon egal' ELSE pokemon.pokemon_name END) as pokemon_name,
        (CASE WHEN pokemon.pokemon_name = 'Any' THEN 0 ELSE pokemon.pokedex_id END) as pokedex_id,
        SUM(attendance.extra_valor + attendance.extra_instinct + attendance.extra_mystic) + count(*) AS raiders
    FROM
        attendance,
		pokemon,
        raids
    WHERE
    	pokemon.pokedex_id = REPLACE(attendance.pokemon, '-normal', '') AND
        raids.id = attendance.raid_id AND
        raids.end_time > NOW() AND
        raids.end_time < NOW() + INTERVAL " . MAP_RAID_END_TIME_OFFSET_HOURS . " hour AND
		attendance.cancel = 0
    GROUP BY attendance.raid_id, attendance.attend_time, attendance.pokemon
    ORDER BY attendance.raid_id, attendance.attend_time ASC";

$rows = array();
try {
    
    $result = $dbh->query($sql_raids);
    while ($raid = $result->fetch(PDO::FETCH_ASSOC)) {
        
        $rows[] = $raid;
    }
} catch (PDOException $exception) {
    
    error_log($exception->getMessage());
    $dbh = null;
    exit();
}
try {
    
    $result = $dbh->query($sql_raiders);
    while ($raiders = $result->fetch(PDO::FETCH_ASSOC)) {
        $attendees[] = $raiders;
    }
} catch (PDOException $exception) {
    
    error_log($exception->getMessage());
    $dbh = null;
    exit();
}


foreach ($rows as $row => $value) {
    
    foreach($attendees as $attendee => $atten){
        if ($value['id'] == $atten['raid_id']) {
            $rows[$row]['raiders'][$atten['attend_time']] = $atten;
        }
    }
}


print json_encode($rows);

$dbh = null;
?>
*/